pipeline {
    agent any
    tools {
        maven 'maven3'
    }
    environment {
        // --- GITHUB REPO/USER (Confirmed) ---
        GIT_REPO_NAME = "CICD" 
        GIT_USER_NAME = "Anahayerramilli" 
        
        // --- DOCKER HUB FINALIZED (Confirmed) ---
        DOCKER_IMAGE = "anaha2211/cicd-app"         
        DOCKER_CRED_ID = "anaha-docker-login"      
        
        // --- SONARQUBE FINALIZED (CASE FIX APPLIED) ---
        // Changed to 'SonarQube' to match the case required by Jenkins global configuration
        SONAR_SERVER_NAME = 'sonarqube'  
        SONAR_URL = 'http://3.145.111.188:9000' 
        
        // --- EKS & DEPLOYMENT DETAILS ---
        EKS_CLUSTER_NAME = "cicd-cluster"      
        AWS_REGION = "us-east-2"               
        DEPLOYMENT_NAME = "mc-app"             
        
        // --- GITHUB COMMITTER EMAIL (Confirmed) ---
        GIT_COMMIT_EMAIL = "anahayerramilli@gmail.com" 
    }
    stages {
        stage('1. Checkout Code') {
            steps {
                echo 'Cloning GIT HUB Repo'
                git branch: 'main', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git" 
            }
        }
        stage('2. Build Artifact') {
            steps {
                echo 'Building the Maven project artifact'
                // This builds the .war file
                sh 'mvn clean verify' 
            }
        }
        stage('3. Sonar Scan') {
            steps {
                echo 'Starting SonarQube analysis'
                // Uses the fixed server name: 'sonarqube'
                withSonarQubeEnv(SONAR_SERVER_NAME) { 
                    sh "mvn sonar:sonar -Dsonar.host.url=${SONAR_URL}"
                }
            }
        }
        
        stage('5. Docker Image Build') {
            steps {
                echo 'Docker Image building and tagging'
                // BUILD_NUMBER is the unique tag
                sh "docker build -t ${DOCKER_IMAGE}:${BUILD_NUMBER} ."
            }
        }

        stage('6. Push to Dockerhub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CRED_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASSWORD')]) { 
                        sh "docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}" 
                        sh "docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                        sh "docker logout"
                    }
                }
            }
        }

        stage('7. GitOps Update Deployment') {
            steps {
                echo 'Update Deployment File in GitOps repository'
                withCredentials([string(credentialsId: 'Jenkins-CICD-Push', variable: 'GITHUB_TOKEN')]) { 
                    sh """
                        git config user.email "${GIT_COMMIT_EMAIL}" 
                        git config user.name "${GIT_USER_NAME}" 
                        
                        # Replace image tag in deployment file (the core GitOps step)
                        sed -i "s|anaha2211/cicd-app:.*|${DOCKER_IMAGE}:${BUILD_NUMBER}|g" deploymentfiles/deployment.yml
                        
                        git add .
                        git commit -m "Update deployment image to version ${BUILD_NUMBER} [skip ci]"
                        
                        # Push the change to trigger deployment
                        git push https://\${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main
                    """
                }
            }
        }
        
    }
}
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed. Please check the logs.'
        }
    }


    